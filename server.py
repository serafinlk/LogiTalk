import socket       #імпортуємо бібліотеку socket: вона дозволяє створювати мережеві з’єднання(TCP/UDP)
import threading    #імпортуємо threading: потрібна для роботи з потоками(щоб сервер міг обслуговувати багато клієнтів одночасно)

#налаштування сервера
HOST = '0.0.0.0'  #це означає, що сервер буде слухати всі доступні мережеві інтерфейси(тобто приймати підключення з будь-якої IP-адреси)
PORT = 8080       #порт, на якому сервер приймає підключення(клієнти підключаються сюди)

#список усіх підключених клієнтів
clients = []  #сюди ми зберігатимемо всі активні клієнтські сокети, щоб знати, кому надсилати повідомлення

def broadcast(data, exclude_socket=None):    #ф-я для розсилання повідомлень усім клієнтам
   #ця ф-я надсилає повідомлення 'data' усім клієнтам, окрім того, хто його надіслав
   for client in clients:  #проходимось по всіх клієнтах
       if client != exclude_socket:  #якщо це не відправник: надсилаємо повідомлення
           try:
               client.sendall(data)  #надсилаємо байти через TCP-сокет
           except:
               #якщо сталася помилка(наприклад, клієнт відключився), то пропускаємо
               pass
#навіщо це потрібно: коли один користувач надсилає повідомлення, сервер має переслати його всім іншим, щоб усі бачили повідомлення в чаті

def handle_client(client_socket):   #ф-я обробки окремого клієнта
    #ця ф-я запускається в окремому потоці для кожного клієнта
    #вона постійно слухає, чи не прийшли нові дані від конкретного клієнта
    while True:
        try:
            #чекаємо отримання даних(повідомлення від клієнта)
            data = client_socket.recv(4096)  #отримуємо до 4096 байтів
            if not data:
                #якщо клієнт нічого не надіслав(наприклад, закрив вікно): виходимо з циклу
                break

            #якщо дані є: розсилаємо їх усім іншим клієнтам(крім поточного)
            broadcast(data, exclude_socket=client_socket)
        except:
            #якщо трапилась будь-яка помилка(наприклад, з’єднання розірване): припиняємо обслуговування
            break

    #коли цикл завершується, то видаляємо клієнта зі списку
    if client_socket in clients:
        clients.remove(client_socket)

    #закриваємо сокет після завершення роботи
    client_socket.close()
#навіщо це потрібно: кожен клієнт обробляється в окремому потоці, щоб сервер не зупинявся, коли один користувач щось відправляє або зависає
#так сервер може одночасно приймати десятки користувачів

def main():     #головна ф-я, що запускає сервер
   #створюємо серверний сокет(TCP)
   server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

   #налаштування, щоб після перезапуску програми можна було знову використовувати той самий порт
   server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)

   #прив язуємо сокет до IP-адреси та порту
   server_socket.bind((HOST, PORT))

   #переводимо сокет у режим "очікування підключень"
   server_socket.listen(5)  #максимум 5 клієнтів у черзі на підключення
   print(f"Сервер запущено на {HOST}:{PORT}")
#навіщо: це підготовка сервера до роботи, тобто він “відкриває двері” для клієнтів, які хочуть приєднатися

   while True:    #цикл приймання нових клієнтів
       #приймаємо нове підключення
       client_socket, addr = server_socket.accept()  #addr - це адреса клієнта(IP, порт)
       print(f"Підключився клієнт: {addr}")

       #додаємо нового клієнта в список активних
       clients.append(client_socket)

       #для кожного клієнта створюємо окремий потік, який слухає його повідомлення
       t = threading.Thread(target=handle_client, args=(client_socket,))
       t.start()  #запускаємо потік
#навіщо: сервер постійно чекає нових підключень і одразу створює для кожного клієнта новий потік, щоб кожен міг працювати незалежно

#запуск програми
if __name__ == "__main__":
   main()  #якщо файл запущено напряму — викликаємо головну функцію main()
#навіщо: ця перевірка гарантує, що сервер запуститься тільки тоді, коли ми запускаємо цей файл напряму, а не імпортуємо його в іншу програму









